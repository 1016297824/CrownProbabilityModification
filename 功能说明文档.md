# 皇冠爆率修改 Mod - 功能详细说明文档

## 文档版本
**版本**：1.0.0  
**更新日期**：2024年  
**适用范围**：CrownProbabilityModification Mod v1.0.0

---

## 1. 功能概述

### 1.1 主要功能
皇冠爆率修改 Mod 提供了一个完整的解决方案，用于在游戏的农场镇场景中根据玩家设定的概率自动生成皇冠物品（ID: 1254）。

### 1.2 功能模块
```
┌─────────────────────────────────────────────┐
│     皇冠爆率修改 Mod 功能模块架构           │
├─────────────────────────────────────────────┤
│  ┌──────────────────────────────────────┐   │
│  │  Mod主控制器 (ModBehaviour)          │   │
│  │  - 场景检测                          │   │
│  │  - 皇冠生成逻辑                      │   │
│  │  - 事件管理                          │   │
│  └──────────────────────────────────────┘   │
│           ↓            ↓           ↓         │
│  ┌──────────────┬──────────────┬──────────┐ │
│  │ 配置管理     │ 场景监听     │ 物品生成 │ │
│  │ (CrownConfig)│  (Event)     │ (Drop)   │ │
│  └──────────────┴──────────────┴──────────┘ │
│           ↓            ↓           ↓         │
│  ┌──────────────┬──────────────┬──────────┐ │
│  │ ModConfig    │ 文件持久化   │ Harmony  │ │
│  │ 配置界面     │ (JSON)       │ 补丁     │ │
│  └──────────────┴──────────────┴──────────┘ │
└─────────────────────────────────────────────┘
```

---

## 2. 配置系统

### 2.1 配置项详解

#### 2.1.1 启用皇冠爆率功能 (EnableCrownDropRate)
- **类型**：布尔值 (Boolean)
- **有效值**：true / false
- **默认值**：false（关闭）
- **说明**：控制整个皇冠生成功能的启用状态
- **应用场景**：
  - 设为 `true` 时，Mod将在农场镇自动根据爆率生成皇冠
  - 设为 `false` 时，Mod将禁用所有皇冠生成逻辑

#### 2.1.2 皇冠爆率 (CrownDropRate)
- **类型**：浮点数 (Float)
- **有效范围**：0.01% - 100%
- **默认值**：0.03%
- **说明**：皇冠生成的概率百分比
- **计算方式**：
  ```
  随机值 = Random.Range(0f, 100f)  // 生成0-100之间的随机数
  if (随机值 <= 爆率) {
    生成皇冠
  }
  ```
- **示例**：
  - 爆率 = 50% → 每次进入农场有50%概率生成皇冠
  - 爆率 = 0.01% → 每次进入农场有0.01%概率生成皇冠
  - 爆率 = 100% → 每次进入农场都一定生成皇冠

### 2.2 配置管理流程

#### 2.2.1 初始化流程
```
1. 游戏启动
   ↓
2. CrownConfig.InitializeConfig() 执行
   ├─ 检查 ModConfig 是否可用
   │  ├─ 可用 → 从 ModConfig 注册配置项
   │  └─ 不可用 → 仅使用本地文件配置
   │
   ├─ 从本地 CrownConfig.json 加载配置
   │
   ├─ 注册 ModConfig 变更事件监听
   │  (当用户在ModConfig界面修改设置时触发)
   │
   └─ 对比本地配置和 ModConfig 中的值
      └─ 如果不同 → 同步到本地文件
```

#### 2.2.2 配置变更流程
```
用户在 ModConfig 界面修改配置
   ↓
OnConfigChanged() 事件触发
   ↓
LoadConfig() 从 ModConfig 加载新值
   ↓
比对新值和旧值是否改变
   ├─ 改变 → SaveLocalConfig() 保存到本地文件
   └─ 未改变 → 不执行任何操作
```

#### 2.2.3 配置优先级

当系统启动时，按以下顺序加载配置：

| 优先级 | 配置源 | 可用性 | 说明 |
|--------|--------|--------|------|
| 1 | ModConfig | 依赖游戏系统 | 用户最后一次设置的值，最高优先级 |
| 2 | CrownConfig.json | 自动生成 | 备份配置，当ModConfig不可用时使用 |
| 3 | 代码默认值 | 始终可用 | 当前两者都不可用时，使用硬编码默认值 |

### 2.3 配置文件格式

#### 2.3.1 CrownConfig.json 文件结构
```json
{
  "EnableCrownDropRate": false,
  "CrownDropRate": 0.03
}
```

**文件位置**：`[DLL目录]/CrownConfig.json`

**示例完整路径**：
```
E:\SteamLibrary\steamapps\common\GameName\Mods\CrownProbabilityModification\CrownConfig.json
```

#### 2.3.2 文件自动管理
- ✅ 首次启动时，若文件不存在，自动创建
- ✅ 配置变更时，自动更新文件内容
- ✅ 游戏重启时，自动加载保存的配置

---

## 3. 皇冠生成机制

### 3.1 生成流程详解

#### 3.1.1 完整生成时序
```
玩家进入农场镇场景 (Level_Farm_Main)
   ↓
场景加载事件触发 (sceneLoaded)
   ├─ 重置生成标志: sceneLevelLoaded = false
   └─ 允许本次进入执行生成逻辑
   ↓
每帧 Update() 执行
   ├─ 检测 sceneLevelLoaded 是否为 false
   │  ├─ true → 已生成过，跳过
   │  └─ false → 继续执行
   │
   ├─ 获取当前场景 ID
   │
   ├─ 判断是否为农场镇 (Level_Farm_Main)
   │  ├─ 是 → 设置标志为 true，执行生成逻辑
   │  └─ 否 → 保持标志不变
   │
   └─ OnFarmLevelLoaded() 执行
      ├─ 检查功能是否启用 (EnableCrownDropRate)
      │  ├─ 禁用 → 直接返回
      │  └─ 启用 → 继续执行
      │
      ├─ 获取当前爆率 (CrownDropRate)
      │
      ├─ 生成 0-100 的随机数
      │
      ├─ 比较：随机数 ≤ 爆率
      │  ├─ 成立 → 调用 GenerateRandomCrown()
      │  └─ 不成立 → 本次不生成
      │
      └─ [本次农场会话结束，不再执行生成逻辑]

玩家离开农场到其他场景
   ↓
新场景加载事件触发
   ├─ 重置标志: sceneLevelLoaded = false
   └─ [为下次进入农场做准备]

玩家再次进入农场
   ↓
[流程重复，可以再次生成皇冠]
```

#### 3.1.2 场景检测机制

**关键概念**：`sceneLevelLoaded` 标志位

| 标志值 | 含义 | 处理方式 |
|--------|------|---------|
| `false` | 本场景未执行生成逻辑 | 允许执行生成逻辑 |
| `true` | 本场景已执行生成逻辑 | 跳过生成逻辑 |

**重置触发条件**：
- 游戏启动时
- 每次加载新场景时（通过 `SceneManager.sceneLoaded` 事件）

### 3.2 生成位置

#### 3.2.1 预设位置坐标
皇冠可以在以下4个位置中随机生成：

```
农场镇地图 (Level_Farm_Main)

位置组A（西侧）：
  ├─ 位置A1: (389.75, 0.00, 657.61)
  └─ 位置A2: (388.74, 0.00, 656.71)

位置组B（东侧）：
  ├─ 位置B1: (528.59, 0.00, 326.56)
  └─ 位置B2: (528.59, 0.00, 326.72)
```

#### 3.2.2 位置选择算法
```
int randomIndex = Random.Range(0, 4)  // 生成 0, 1, 2, 3
Vector3 selectedPos = targetPositions[randomIndex]  // 选择对应位置
```

**概率分布**：4个位置等概率，每个位置各占25%

### 3.3 物品显示机制

#### 3.3.1 关键方法：ItemExtensions.Drop()
```csharp
// 核心代码
crownItem.Drop(position, isQuiet, upDirection, torque);

// 参数说明：
// - position: 生成位置坐标
// - isQuiet: 是否静音（false=正常显示和声音）
// - upDirection: 物品向上方向（Vector3.up）
// - torque: 旋转力度（0=无旋转）
```

#### 3.3.2 显示效果
- ✅ 物品以物理效果显示在地面上
- ✅ 玩家可以直接拾取
- ✅ 支持正常的物品交互

---

## 4. 事件管理

### 4.1 场景加载事件

#### 4.1.1 事件注册
```csharp
// 在 ModBehaviour.Start() 中执行
UnityEngine.SceneManagement.SceneManager.sceneLoaded += sceneLoadedHandler;
```

#### 4.1.2 事件处理器
```csharp
private UnityEngine.Events.UnityAction<Scene, LoadSceneMode> sceneLoadedHandler = 
  (scene, mode) => {
    sceneLevelLoaded = false;  // 重置生成标志
  };
```

#### 4.1.3 事件注销
```csharp
// 在 ModBehaviour.OnDisable() 中执行
UnityEngine.SceneManagement.SceneManager.sceneLoaded -= sceneLoadedHandler;
```

### 4.2 配置变更事件

#### 4.2.1 事件监听
```csharp
ModConfigAPI.SafeAddOnOptionsChangedDelegate(OnConfigChanged);
```

#### 4.2.2 变更处理
```csharp
private void OnConfigChanged(string key) {
  if (key == FULL_ENABLE_CROWN_KEY || key == FULL_CROWN_DROP_RATE_KEY) {
    LoadConfig();  // 重新加载配置
    if (配置确实改变) {
      SaveLocalConfig();  // 保存到本地文件
    }
  }
}
```

---

## 5. 性能优化

### 5.1 Update() 方法优化

#### 5.1.1 优化前（有性能问题）
```csharp
// ❌ 每帧都在执行重复检测
private void Update() {
  var scene = SceneManager.GetActiveScene();
  if (scene.name == "Level_Farm_Main") {
    OnFarmLevelLoaded();  // 每帧都执行
  }
}
```

#### 5.1.2 优化后（高效）
```csharp
// ✅ 只在首次进入时执行
private void Update() {
  if (!sceneLevelLoaded) {
    var scene = SceneManager.GetActiveScene();
    if (scene.name == "Level_Farm_Main") {
      sceneLevelLoaded = true;  // 标记已处理
      OnFarmLevelLoaded();      // 只执行一次
    }
  }
}
```

### 5.2 性能指标
- **CPU占用**：极低（仅在进入农场时执行一次）
- **内存占用**：恒定（配置项和事件处理器固定大小）
- **帧率影响**：无（不阻塞主线程）

---

## 6. 容错机制

### 6.1 ModConfig 不可用时的处理

#### 6.1.1 检测逻辑
```csharp
if (!ModConfigAPI.IsAvailable()) {
  // ModConfig 不可用
  LoadLocalConfig();  // 从本地文件加载
  return;
}
```

#### 6.1.2 回退方案
1. **第一级**：尝试加载 ModConfig 配置
2. **第二级**：使用本地 JSON 文件配置
3. **第三级**：使用代码硬编码默认值

### 6.2 文件损坏处理

#### 6.2.1 JSON 解析异常
```csharp
try {
  // 解析 JSON
  if (float.TryParse(value, out float floatValue)) {
    CrownDropRate = Mathf.Clamp(floatValue, 0.01f, 100f);
  }
} catch (Exception ex) {
  Debug.LogError($"[皇冠配置] 加载失败: {ex.Message}");
  // 使用默认值
}
```

#### 6.2.2 文件不存在处理
```csharp
if (!File.Exists(persistentConfigPath)) {
  SaveLocalConfig();  // 自动创建默认配置文件
}
```

---

## 7. 故障排查指南

### 7.1 常见问题及解决方案

| 问题 | 原因 | 解决方案 |
|------|------|---------|
| 皇冠不生成 | 功能未启用 | 检查 EnableCrownDropRate = true |
| 皇冠不生成 | 爆率过低 | 增加 CrownDropRate 的值，多次尝试 |
| 皇冠不生成 | 场景错误 | 确认在农场镇场景（Level_Farm_Main） |
| 配置重启丢失 | 文件权限问题 | 检查DLL目录写入权限 |
| 配置重启丢失 | 文件路径错误 | 确保CrownConfig.json在DLL同目录 |
| 性能下降 | 其他原因 | 检查系统资源和日志 |

### 7.2 调试方法

#### 7.2.1 配置验证
```
步骤1：打开 ModConfig 界面
步骤2：查找 "CrownProbabilityModification" 分组
步骤3：确认两个配置项都存在且值正确
步骤4：修改一个值，检查是否被保存
```

#### 7.2.2 文件检查
```
步骤1：找到 DLL 文件位置
步骤2：检查同目录是否有 CrownConfig.json
步骤3：用文本编辑器打开，验证 JSON 格式是否正确
```

#### 7.2.3 场景确认
```
步骤1：进入农场镇
步骤2：打开游戏控制台或日志文件
步骤3：确认当前场景 ID 是 "Level_Farm_Main"
```

---

## 8. 自定义和扩展

### 8.1 修改爆率范围

**修改位置**：`CrownConfig.cs` 中的 `Mathf.Clamp()` 调用

```csharp
// 原始范围：0.01 - 100
CrownDropRate = Mathf.Clamp(floatValue, 0.01f, 100f);

// 修改为：0.001 - 1000
CrownDropRate = Mathf.Clamp(floatValue, 0.001f, 1000f);
```

### 8.2 更改生成物品

**修改位置**：`ModBehaviour.cs` 中的 `GenerateRandomCrown()` 方法

```csharp
// 原始物品：1254（皇冠）
int itemId = 1254;

// 修改为其他物品ID（例如：999）
int itemId = 999;
```

### 8.3 自定义生成位置

**修改位置**：`ModBehaviour.cs` 中的 `targetPositions` 数组

```csharp
Vector3[] targetPositions = new Vector3[] {
  new Vector3(389.75f, 0.00f, 657.61f),  // 修改这些坐标
  new Vector3(388.74f, 0.00f, 656.71f),
  new Vector3(528.59f, 0.00f, 326.56f),
  new Vector3(528.59f, 0.00f, 326.72f)
};
```

### 8.4 修改默认配置值

**修改位置**：`CrownConfig.cs` 中的字段初始化

```csharp
// 修改默认启用状态
public static bool EnableCrownDropRate { get; private set; } = true;  // 改为 true

// 修改默认爆率
public static float CrownDropRate { get; private set; } = 50f;  // 改为 50%
```

---

## 9. 技术细节

### 9.1 关键代码片段

#### 9.1.1 概率判定
```csharp
float crownDropRate = CrownConfig.CrownDropRate;  // 获取爆率（如：50）
float randomChance = Random.Range(0f, 100f);       // 生成 0-100 随机数

if (randomChance <= crownDropRate) {
  GenerateRandomCrown();  // 随机数 ≤ 爆率，执行生成
}
```

#### 9.1.2 物品实例化和显示
```csharp
var crownItem = ItemStatsSystem.ItemAssetsCollection.InstantiateSync(itemId);

if (crownItem != null) {
  crownItem.transform.position = selectedPos;
  crownItem.transform.rotation = Quaternion.identity;
  crownItem.Drop(selectedPos, false, Vector3.up, 0f);
}
```

### 9.2 数据流向

```
ModConfig 界面
  ↓ (用户修改)
ModConfig 系统
  ↓ (加载值)
CrownConfig.LoadConfig()
  ↓ (更新内存)
静态属性：EnableCrownDropRate, CrownDropRate
  ↓ (使用配置)
ModBehaviour.OnFarmLevelLoaded()
  ↓ (保存)
CrownConfig.SaveLocalConfig()
  ↓ (写入文件)
CrownConfig.json
```

---

## 10. 版本信息

| 项目 | 信息 |
|------|------|
| Mod名称 | Crown Probability Modification |
| 版本号 | 1.0.0 |
| 编译环境 | .NET Standard 2.1 |
| 框架 | Harmony + ModConfig API |
| 最后更新 | 2024年 |
| 维护状态 | 活跃 |

---

## 11. 相关资源

### 11.1 文件列表
```
CrownProbabilityModification/
├── ModBehaviour.cs          - 主逻辑入口
├── CrownConfig.cs           - 配置管理
├── ModConfigApi.cs          - ModConfig API 封装
├── HarmonyLoad.cs           - Harmony 加载
├── CrownConfig.json         - 本地配置（自动生成）
├── README.md                - 快速使用指南
└── 功能说明文档.md          - 本文档
```

### 11.2 相关技术
- **Harmony**：代码注入和补丁框架
- **ModConfig**：游戏内配置管理系统
- **Unity**：游戏引擎基础
- **C#**：编程语言

---

## 附录：配置示例

### 示例1：低爆率
```json
{
  "EnableCrownDropRate": true,
  "CrownDropRate": 0.1
}
```
说明：每1000次进入农场约生成1次皇冠

### 示例2：中等爆率
```json
{
  "EnableCrownDropRate": true,
  "CrownDropRate": 10
}
```
说明：每10次进入农场约生成1次皇冠

### 示例3：高爆率
```json
{
  "EnableCrownDropRate": true,
  "CrownDropRate": 100
}
```
说明：每次进入农场都生成皇冠

---

## 文档结束

本文档提供了完整的功能说明和技术细节。如有问题，请参考故障排查部分或查阅相关源代码。
